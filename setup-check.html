<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heavy Chain - è¨­å®šãƒã‚§ãƒƒã‚¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .icon {
            font-size: 20px;
            margin-right: 12px;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 12px;
        }
        button:hover {
            background: #4338ca;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 12px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 20px 0 12px 0;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Heavy Chain è¨­å®šãƒã‚§ãƒƒã‚¯</h1>
    <p style="color: #666; margin-bottom: 24px;">
        ã“ã®ãƒšãƒ¼ã‚¸ã§Heavy Chainã®è¨­å®šçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
        Zeaburã®ç’°å¢ƒå¤‰æ•°ã¯è¨­å®šæ¸ˆã¿ã¨ã®ã“ã¨ãªã®ã§ã€Supabaseå´ã®è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚
    </p>

    <div class="card">
        <div class="section-title">âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ï¼ˆZeaburï¼‰</div>
        <div id="env-check"></div>
    </div>

    <div class="card">
        <div class="section-title">ğŸ—„ï¸ Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</div>
        <div id="supabase-check"></div>
        <button onclick="testSupabaseConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="card">
        <div class="section-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</div>
        <div id="tables-check"></div>
        <button onclick="checkTables()">ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</button>
    </div>

    <div class="card">
        <div class="section-title">ğŸš€ Edge Functionsç¢ºèª</div>
        <div id="functions-check"></div>
        <button onclick="checkEdgeFunctions()">Edge Functionsç¢ºèª</button>
    </div>

    <div class="card">
        <div class="section-title">ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</div>
        <div id="debug-log" class="log">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        let supabase;
        let logContent = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logContent += `[${timestamp}] ${prefix} ${message}\n`;
            document.getElementById('debug-log').textContent = logContent;
        }

        // Check environment variables
        function checkEnvVariables() {
            const envCheck = document.getElementById('env-check');
            const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
            const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

            let html = '';

            if (supabaseUrl) {
                html += `<div class="status ok"><span class="icon">âœ…</span><div><strong>VITE_SUPABASE_URL</strong><br><code>${supabaseUrl.substring(0, 30)}...</code></div></div>`;
                log(`VITE_SUPABASE_URL: ${supabaseUrl}`, 'success');
            } else {
                html += `<div class="status error"><span class="icon">âŒ</span><div><strong>VITE_SUPABASE_URL</strong><br>æœªè¨­å®š</div></div>`;
                log('VITE_SUPABASE_URL: æœªè¨­å®š', 'error');
            }

            if (supabaseKey) {
                html += `<div class="status ok"><span class="icon">âœ…</span><div><strong>VITE_SUPABASE_ANON_KEY</strong><br><code>${supabaseKey.substring(0, 20)}...</code></div></div>`;
                log('VITE_SUPABASE_ANON_KEY: è¨­å®šæ¸ˆã¿', 'success');
            } else {
                html += `<div class="status error"><span class="icon">âŒ</span><div><strong>VITE_SUPABASE_ANON_KEY</strong><br>æœªè¨­å®š</div></div>`;
                log('VITE_SUPABASE_ANON_KEY: æœªè¨­å®š', 'error');
            }

            envCheck.innerHTML = html;

            if (supabaseUrl && supabaseKey) {
                supabase = createClient(supabaseUrl, supabaseKey);
                log('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æˆåŠŸ', 'success');
            }
        }

        // Test Supabase connection
        window.testSupabaseConnection = async function() {
            const checkDiv = document.getElementById('supabase-check');
            checkDiv.innerHTML = '<div class="status warning"><span class="icon">â³</span><div>æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...</div></div>';
            log('Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');

            if (!supabase) {
                checkDiv.innerHTML = '<div class="status error"><span class="icon">âŒ</span><div>Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>';
                log('æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ç’°å¢ƒå¤‰æ•°æœªè¨­å®š', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.getSession();
                if (error) throw error;

                checkDiv.innerHTML = `<div class="status ok"><span class="icon">âœ…</span><div><strong>æ¥ç¶šæˆåŠŸ</strong><br>${data.session ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}</div></div>`;
                log('Supabaseæ¥ç¶šæˆåŠŸ', 'success');
                if (data.session) {
                    log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${data.session.user.id}`, 'success');
                }
            } catch (error) {
                checkDiv.innerHTML = `<div class="status error"><span class="icon">âŒ</span><div><strong>æ¥ç¶šã‚¨ãƒ©ãƒ¼</strong><br>${error.message}</div></div>`;
                log(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // Check tables
        window.checkTables = async function() {
            const checkDiv = document.getElementById('tables-check');
            checkDiv.innerHTML = '<div class="status warning"><span class="icon">â³</span><div>ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªä¸­...</div></div>';
            log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªé–‹å§‹...');

            if (!supabase) {
                checkDiv.innerHTML = '<div class="status error"><span class="icon">âŒ</span><div>Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>';
                log('ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªå¤±æ•—: ç’°å¢ƒå¤‰æ•°æœªè¨­å®š', 'error');
                return;
            }

            const requiredTables = ['brands', 'generated_images', 'folders'];
            let html = '';
            let allOk = true;

            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    html += `<div class="status ok"><span class="icon">âœ…</span><div><strong>${table}</strong> ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨</div></div>`;
                    log(`ãƒ†ãƒ¼ãƒ–ãƒ« ${table}: å­˜åœ¨`, 'success');
                } catch (error) {
                    html += `<div class="status error"><span class="icon">âŒ</span><div><strong>${table}</strong> ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒ©ãƒ¼<br><code>${error.message}</code></div></div>`;
                    log(`ãƒ†ãƒ¼ãƒ–ãƒ« ${table}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'error');
                    allOk = false;
                }
            }

            if (!allOk) {
                html += '<div class="status warning"><span class="icon">âš ï¸</span><div><strong>å¯¾å‡¦æ–¹æ³•</strong><br>Supabase Dashboard â†’ SQL Editor ã§<br><code>supabase/migrations/001_initial_schema.sql</code>ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div></div>';
            }

            checkDiv.innerHTML = html;
        };

        // Check Edge Functions
        window.checkEdgeFunctions = async function() {
            const checkDiv = document.getElementById('functions-check');
            checkDiv.innerHTML = '<div class="status warning"><span class="icon">â³</span><div>Edge Functionsç¢ºèªä¸­...</div></div>';
            log('Edge Functionsç¢ºèªé–‹å§‹...');

            if (!supabase) {
                checkDiv.innerHTML = '<div class="status error"><span class="icon">âŒ</span><div>Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>';
                log('Edge Functionsç¢ºèªå¤±æ•—: ç’°å¢ƒå¤‰æ•°æœªè¨­å®š', 'error');
                return;
            }

            const functions = [
                'generate-image',
                'product-shots',
                'colorize',
                'remove-background',
                'upscale'
            ];

            let html = '';
            let deployedCount = 0;

            for (const func of functions) {
                try {
                    // Try to invoke with minimal data to check if function exists
                    const { error } = await supabase.functions.invoke(func, {
                        body: { test: true }
                    });
                    
                    // If we get a response (even error), function is deployed
                    if (error && error.message.includes('not found')) {
                        html += `<div class="status error"><span class="icon">âŒ</span><div><strong>${func}</strong><br>ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>`;
                        log(`Edge Function ${func}: æœªãƒ‡ãƒ—ãƒ­ã‚¤`, 'error');
                    } else {
                        html += `<div class="status ok"><span class="icon">âœ…</span><div><strong>${func}</strong><br>ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿</div></div>`;
                        log(`Edge Function ${func}: ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿`, 'success');
                        deployedCount++;
                    }
                } catch (error) {
                    html += `<div class="status warning"><span class="icon">âš ï¸</span><div><strong>${func}</strong><br>ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ</div></div>`;
                    log(`Edge Function ${func}: ç¢ºèªã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'error');
                }
            }

            html += `<div class="status ${deployedCount === functions.length ? 'ok' : 'warning'}"><span class="icon">${deployedCount === functions.length ? 'âœ…' : 'âš ï¸'}</span><div><strong>ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³</strong><br>${deployedCount} / ${functions.length} é–¢æ•°ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿</div></div>`;

            if (deployedCount < functions.length) {
                html += '<div class="status warning"><span class="icon">âš ï¸</span><div><strong>å¯¾å‡¦æ–¹æ³•</strong><br>Supabase CLIã§é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ï¼š<br><code>supabase functions deploy [function-name]</code></div></div>';
            }

            checkDiv.innerHTML = html;
        };

        // Initialize on page load
        checkEnvVariables();
    </script>
</body>
</html>

